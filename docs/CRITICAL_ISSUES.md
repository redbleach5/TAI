# Критичные проблемы и ошибки проекта

Анализ выполнен 2025-02-01.

## Критичные (исправлено / требуют внимания)

### 1. Path traversal в FileReaderHandler (@code / @file) — **ИСПРАВЛЕНО**

**Проблема:** Обработчик команд `@code` и `@file` проверял только абсолютные пути. Относительный путь вроде `../../etc/passwd` не проверялся и позволял читать файлы вне текущего каталога проекта.

**Исправление:** В `src/application/chat/handlers/file_reader.py` путь разрешается относительно **workspace** (из projects store), и результат проверяется через `relative_to(base)` — доступ разрешён только внутри workspace.

---

### 2. Падающий интеграционный тест `test_chat_code_returns_response`

**Проблема:** Тест вызывает реальный LLM (Ollama). Без запущенного Ollama по адресу из конфига (`config/default.toml` → `http://192.168.178.126:11434`) тест падает с `ConnectionError: Failed to connect to Ollama`.

**Рекомендация:** Либо помечать тест как требующий Ollama (как RAG-тесты с `SKIP`), либо мокать LLM в этом тесте, чтобы CI и локальный прогон не зависели от внешнего сервиса.

---

### 3. Ссылки на удалённые документы в README и check.md — **ИСПРАВЛЕНО**

**Было:** README и check.md ссылались на несуществующие plan.md, ARCHITECTURE.md, API_REFERENCE.md.

**Исправление:** README обновлён: ссылки ведут на актуальные документы (docs/ARCHITECTURE.md создан, docs/CHECKLIST.md вместо check.md). CONTRIBUTING указывает на docs/ARCHITECTURE.md.

---

### 4. Жёстко заданный хост Ollama в конфиге

**Проблема:** В `config/default.toml` указан конкретный IP: `host = "http://192.168.178.126:11434"`. На другой машине или в CI Ollama по этому адресу недоступен.

**Рекомендация:** По умолчанию использовать `http://localhost:11434` и переопределять через `development.toml` или переменные окружения (см. `.env.example`).

---

## Важные (не критичные)

### 5. Проверка пути в FileService._is_safe_path

**Проблема:** Используется `str(resolved).startswith(str(self._root))`. На Windows при разных дисках или в краевых случаях с symlinks это может вести себя неверно.

**Рекомендация:** Проверять через `resolved.relative_to(self._root)` и перехватывать `ValueError` (или использовать `is_relative_to()` в Python 3.9+).

---

### 6. Frontend: история в sync-чате — **ИСПРАВЛЕНО**

**Проблема:** В `useChat.ts` при синхронном `postChat` в запрос передавалась `history: messages.map(...)`. Из-за замыкания в момент вызова `messages` мог быть устаревшим (stale closure).

**Исправление:** Добавлен ref `messagesRef`, обновляемый при каждом рендере; при sync-запросе история формируется из `messagesRef.current`, чтобы всегда отправлять актуальный список предыдущих сообщений. Контракт API зафиксирован: `history` = только предыдущие реплики; текущее сообщение передаётся в `message` и дополняется на бэкенде (см. `ChatRequest` в dto.py).

---

### 7. Container.reset() и _config_override

**Поведение:** После `reset()` кэш контейнера очищается, но `_config_override` остаётся. При следующем обращении к `config` вернётся переданный при создании override. Если это не задумано для тестов — учитывать при написании тестов и документации.

---

## Итог

| Категория        | Количество |
|------------------|------------|
| Критичные        | 4 (1 исправлено) |
| Важные           | 3          |

Рекомендуется: исправить тест чата (мок или skip), поправить ссылки в README/check.md и вынести хост Ollama в переменные окружения или local config.
